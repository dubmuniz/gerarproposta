<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Preenchimento de Formulários de Propostas — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    label{display:block;font-weight:600;margin:4px 0 6px}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{min-height:120px;resize:vertical}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin-top:8px;font-size:13px;display:none}
    .btn{background:var(--green);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:8px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .debug{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:260px;overflow:auto;white-space:pre-wrap}
    .hidden{display:none}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#667085;font-size:12px}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Ferramenta de Preenchimento de Formulários de Propostas</h1>
    <p class="lead">Faça upload do Marco Lógico, Edital e Formulário. A IA preenche respostas respeitando critérios, requisitos e limites.</p>
  </header>

  <main class="wrap">
    <form id="formTool" class="grid" novalidate>
      <div>
        <label>1) Marco Lógico (PDF, DOCX, TXT, XLSX, XLS)</label>
        <input type="file" id="marcoFile" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls" required>
        <div id="marcoInfo" class="file-info"></div>
      </div>

      <div>
        <label>2) Edital (PDF, DOCX, TXT)</label>
        <input type="file" id="editalFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="editalInfo" class="file-info"></div>
      </div>

      <div>
        <label>3) Formulário da Proposta (DOCX, DOC, PDF, XLSX, XLS, TXT)</label>
        <input type="file" id="formFile" accept=".docx,.doc,.pdf,.xlsx,.xls,.txt" required>
        <div id="formInfo" class="file-info"></div>
      </div>

      <div class="two">
        <div>
          <label>Nome do Projeto</label>
          <input id="projectName" type="text" placeholder="Ex: Territórios Vivos, Ilha do Bananal">
        </div>
        <div>
          <label>Parceiro / Chamada</label>
          <input id="partnerName" type="text" placeholder="Ex: União Europeia">
        </div>
      </div>

      <div>
        <label>Observações adicionais</label>
        <textarea id="notes" placeholder="Pontos de ênfase, palavras-chave, público prioritário"></textarea>
      </div>

      <div class="two">
        <div>
          <label>Idioma de saída</label>
          <select id="lang">
            <option value="pt-BR" selected>Português (pt-BR)</option>
            <option value="es">Español (es)</option>
            <option value="en">English (en)</option>
          </select>
          <div class="muted">O backend usa Claude via Make</div>
        </div>
        <div>
          <label>Arquivo DOCX gerado</label>
          <input id="outFile" type="text" placeholder="Ex: Propuesta_TerritoriosVivos_es.docx">
        </div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Gerar Proposta DOCX</button>
      <p id="status" class="status"></p>
      <div id="debug" class="debug hidden"></div>
    </form>
  </main>

  <script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/a82pipio62kal4ywr4mlmj6w9umqfud4';

    const $ = s => document.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    const sanitize = s => (s==null?'':String(s).replace(/\s+/g,' ').trim());
    const safeSlice = (t,n)=>sanitize(String(t||'')).slice(0,n);

    async function safeFetch(url,opts={}){
      const resp=await fetch(url,opts);const text=await resp.text();return{ok:resp.ok,status:resp.status,statusText:resp.statusText,headers:resp.headers,text};}

    async function readAny(file){return sanitize(await file.text());}

    async function handleFile(inputEl,infoEl){
      const f=inputEl.files[0];if(!f){infoEl.style.display='none';return'';}
      infoEl.textContent='Lendo arquivo...';infoEl.style.display='block';
      try{const txt=await readAny(f);infoEl.textContent=`✓ ${f.name}`;return txt;}catch(e){infoEl.textContent='Erro ao ler';return'';}
    }

    let MARCO_TXT='',EDITAL_TXT='',FORM_TXT='';
    $('#marcoFile').addEventListener('change',async()=>{MARCO_TXT=await handleFile($('#marcoFile'),$('#marcoInfo'));});
    $('#editalFile').addEventListener('change',async()=>{EDITAL_TXT=await handleFile($('#editalFile'),$('#editalInfo'));});
    $('#formFile').addEventListener('change',async()=>{FORM_TXT=await handleFile($('#formFile'),$('#formInfo'));});

    document.getElementById('formTool').addEventListener('submit',async e=>{
      e.preventDefault();hide($('#debug'));
      const st=$('#status');st.classList.remove('error','success');st.textContent='';
      if(!MARCO_TXT||!EDITAL_TXT||!FORM_TXT){st.textContent='Anexe os três arquivos.';st.classList.add('error');return;}
      try{
        $('#submitBtn').disabled=true;st.textContent='Preparando pacote...';
        const compact={lang:$('#lang').value.trim(),project:$('#projectName').value.trim(),partner:$('#partnerName').value.trim(),notes:$('#notes').value.trim(),marco_excerpt:safeSlice(MARCO_TXT,6000),edital_excerpt:safeSlice(EDITAL_TXT,8000),form_excerpt:safeSlice(FORM_TXT,4000)};
        const b64=btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
        const payload={lang:compact.lang,project:compact.project,partner:compact.partner,outFile:$('#outFile').value.trim(),compact_b64:b64};
        st.textContent='Enviando...';
        const{ok,status,statusText,headers,text}=await safeFetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        $('#debug').textContent=`Status:${status} ${statusText}\n${text.slice(0,2000)}`;show($('#debug'));
        if(!ok)throw new Error('HTTP '+status);
        const jsonStart=text.indexOf('{');const jsonEnd=text.lastIndexOf('}');
        const core=text.slice(jsonStart,jsonEnd+1);
        const data=JSON.parse(core);
        if(!data||!Array.isArray(data.filled_form))throw new Error('Resposta inválida');
        st.textContent='✓ DOCX gerado';st.classList.add('success');
      }catch(err){st.textContent='Erro: '+err.message;st.classList.add('error');}
      finally{$('#submitBtn').disabled=false;}
    });
  </script>
</body>
</html>



