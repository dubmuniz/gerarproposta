<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Preenchimento de Formulários de Propostas — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    label{display:block;font-weight:600;margin:4px 0 6px}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{min-height:120px;resize:vertical}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin-top:8px;font-size:13px;display:none}
    .btn{background:var(--green);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:8px 0 0;font-size:14px}
    .status.error{color:#d32f2f}.status.success{color:#1E7E34}
    .debug{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:260px;overflow:auto;white-space:pre-wrap}
    .hidden{display:none}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#667085;font-size:12px}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Ferramenta de Preenchimento de Formulários de Propostas</h1>
    <p class="lead">Saída sempre em português, mesmo com perguntas em espanhol.</p>
  </header>

  <main class="wrap">
    <form id="formTool" class="grid" novalidate>
      <div>
        <label>1) Marco Lógico (PDF, DOCX, TXT, XLSX, XLS)</label>
        <input type="file" id="marcoFile" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls" required>
        <div id="marcoInfo" class="file-info"></div>
      </div>

      <div>
        <label>2) Edital (PDF, DOCX, TXT)</label>
        <input type="file" id="editalFile" accept=".pdf,.docx,.doc,.txt" required>
        <div id="editalInfo" class="file-info"></div>
      </div>

      <div>
        <label>3) Formulário da Proposta (DOCX, DOC, PDF, XLSX, XLS, TXT)</label>
        <input type="file" id="formFile" accept=".docx,.doc,.pdf,.xlsx,.xls,.txt" required>
        <div id="formInfo" class="file-info"></div>
      </div>

      <div class="two">
        <div>
          <label>Nome do Projeto</label>
          <input id="projectName" type="text" placeholder="Ex: Territórios Vivos — Ilha do Bananal">
        </div>
        <div>
          <label>Parceiro / Chamada</label>
          <input id="partnerName" type="text" placeholder="Ex: União Europeia">
        </div>
      </div>

      <div>
        <label>Observações adicionais</label>
        <textarea id="notes" placeholder="Ênfases, palavras-chave, público prioritário"></textarea>
      </div>

      <div class="two">
        <div>
          <label>Idioma de saída</label>
          <select id="lang">
            <option value="pt-BR" selected>Português (pt-BR)</option>
            <option value="es">Español (es)</option>
            <option value="en">English (en)</option>
          </select>
          <div class="muted">Backend: Claude via Make</div>
        </div>
        <div>
          <label>Arquivo DOCX gerado</label>
          <input id="outFile" type="text" placeholder="Ex: Propuesta_TerritoriosVivos_pt-BR.docx">
        </div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Gerar Proposta DOCX</button>
      <p id="status" class="status"></p>
      <div id="debug" class="debug hidden"></div>
    </form>
  </main>

  <script>
    const WEBHOOK_URL='https://hook.us2.make.com/a82pipio62kal4ywr4mlmj6w9umqfud4';
    const BATCH_SIZE=8;

    const $=s=>document.querySelector(s);
    const show=el=>el.classList.remove('hidden');
    const hide=el=>el.classList.add('hidden');
    const sanitize=s=>(s==null?'':String(s).replace(/^\uFEFF/,'').replace(/\uFEFF/g,'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim());
    const safeSlice=(t,n)=>sanitize(String(t||'')).slice(0,n);

    async function safeFetch(url,opts={}){const r=await fetch(url,opts);const text=await r.text();return{ok:r.ok,status:r.status,statusText:r.statusText,headers:r.headers,text};}

    async function readPDF(file){const arr=await file.arrayBuffer();pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';const pdf=await pdfjsLib.getDocument({data:arr}).promise;let text='';for(let p=1;p<=pdf.numPages;p++){const pg=await pdf.getPage(p);const tc=await pg.getTextContent();text+=tc.items.map(i=>i.str).join(' ')+' ';}return sanitize(text);}
    async function readDOCX(file){const arr=await file.arrayBuffer();const res=await mammoth.extractRawText({arrayBuffer:arr});return sanitize(res.value);}
    async function readXLSX(file){const arr=await file.arrayBuffer();const wb=XLSX.read(arr,{type:'array'});let out='';wb.SheetNames.forEach(n=>{const ws=wb.Sheets[n];out+=`\n[${n}]\n`+XLSX.utils.sheet_to_csv(ws,{FS:'\t',RS:'\n'})+'\n'});try{const first=wb.Sheets[wb.SheetNames[0]];const json=XLSX.utils.sheet_to_json(first,{defval:'',raw:true});out+='\n'+json.slice(0,300).map(o=>Object.values(o).join(' | ')).join('\n')}catch(_){ }return sanitize(out);}
    async function readAny(file){const n=(file.name||'').toLowerCase();if(n.endsWith('.pdf'))return readPDF(file);if(n.endsWith('.docx')||n.endsWith('.doc'))return readDOCX(file);if(n.endsWith('.xlsx')||n.endsWith('.xls'))return readXLSX(file);return sanitize(await file.text());}
    async function handleFile(inputEl,infoEl,reader){const f=inputEl.files[0];if(!f){infoEl.style.display='none';return'';}infoEl.textContent='Lendo arquivo...';infoEl.style.display='block';try{const txt=await reader(f);infoEl.textContent=`✓ ${f.name}`;return txt;}catch(e){infoEl.textContent='Erro ao ler: '+e.message;return'';}}

    function extractLimitsBlock(text){const lim=[];const rx=/\b(?:at[eé]\s*)?(\d{1,4})\s*(caracteres|palavras|caracter|palabra|palabras)\b/gi;let m;while((m=rx.exec(text))!==null){lim.push({value:parseInt(m[1],10),unit:m[2].toLowerCase()});}const rxPg=/\bm[aá]ximo\s+(\d{1,2})\s+p[aá]ginas?\b/gi;while((m=rxPg.exec(text))!==null){const p=Math.max(1,parseInt(m[1],10));lim.push({value:p*500,unit:'palavras'});}return lim;}
    function normalizeLimit(lim){if(!lim)return null;let u=(lim.unit||'').toLowerCase();u=u.replace('caracteres','chars').replace('caracter','chars').replace('palavras','words').replace('palabra','words').replace('palabras','words');return{value:lim.value,type:u};}
    function isInstructionLike(q){const t=String(q||'').toLowerCase();if(/^\[/.test(t))return true; if(/instrucci[oó]nes|instru[cç][oõ]es|instruções|cumplimente|rellene|suprima|preencher/.test(t))return true; if(t.length>360)return true; return false;}
    function parseFormQuestionsGeneric(text){
      const lines=String(text||'').split(/\n|(?<=\?)\s+/).map(s=>s.trim()).filter(Boolean);
      const qs=[];
      for(const L of lines){
        const isQ=/[:?]$/.test(L)||/^\d+(\.\d+)*[)\.-]?\s+/.test(L)||/^t[ií]tulo|resumen|resumo|objetivo|metodolog[ií]a|p[úu]blico|pertin(e|é)ncia|pertinencia|justificativa/i.test(L);
        if(isQ){const lim=extractLimitsBlock(L);qs.push({question:L.replace(/\s*[:?]$/,''),limit:lim.length?normalizeLimit(lim[0]):null});}
      }
      const uniq=[];const seen=new Set();
      for(const q of qs){const k=q.question.toLowerCase();if(seen.has(k))continue;if(isInstructionLike(q.question))continue;seen.add(k);uniq.push(q);}
      return uniq.slice(0,120);
    }

    const H=docx.HeadingLevel;
    const P=(t,opts={})=>new docx.Paragraph({text:t||'',...opts});
    const H1=t=>P(t,{heading:H.HEADING_1});
    const H2=t=>P(t,{heading:H.HEADING_2});
    function docFromFilled(filled,meta){
      const children=[];
      children.push(H1(meta?.title||'Proposta — Formulário Preenchido'));
      if(meta?.project)children.push(P('Projeto: '+meta.project));
      if(meta?.partner)children.push(P('Chamada: '+meta.partner));
      children.push(P(''));
      filled.forEach((item,idx)=>{
        children.push(H2(`${idx+1}. ${item.question}`));
        const lim=item.limit||null;
        const unitKey=lim&&(lim.type||lim.unit)||'';
        const unitLabel=String(unitKey).startsWith('char')?'caracteres':(String(unitKey).startsWith('word')?'palavras':'');
        if(lim&&lim.value)children.push(P(`Limite: até ${lim.value} ${unitLabel}`));
        children.push(P(item.answer||''));children.push(P(''));
      });
      return new docx.Document({sections:[{properties:{},children}]});
    }
    async function saveDocx(doc,filename){const blob=await docx.Packer.toBlob(doc);const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename||('Proposta_'+Date.now()+'.docx');document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}

    function stripFencesAndBOM(s){if(!s)return'';let t=String(s).replace(/^\uFEFF/,'').trim();if(t.startsWith('```'))t=t.replace(/^```(?:json)?\s*/i,'');if(t.endsWith('```'))t=t.slice(0,-3);return t.trim();}
    function extractBalancedFromStringToJSON(s,startIndex,openCh,closeCh){
      let inStr=false,esc=false,depth=0;
      for(let i=startIndex;i<s.length;i++){
        const c=s[i];
        if(inStr){if(esc){esc=false;continue}if(c==='\\'){esc=true;continue}if(c==='"'){inStr=false;continue}}
        else{
          if(c==='"'){inStr=true;continue}
          if(c===openCh){depth++}
          else if(c===closeCh){depth--;if(depth===0){const cand=s.slice(startIndex,i+1).trim();try{return JSON.parse(cand)}catch(_){try{const cleaned=cand.replace(/}\s*[\s\S]*$/,'}').replace(/]\s*[\s\S]*$/ ,']');return JSON.parse(cleaned)}catch(__){return null}}}}
      }
      return null;
    }
    function extractFirstJSONValue(raw){
      const s=stripFencesAndBOM(raw),n=s.length;
      for(let i=0;i<n;i++){const c=s[i];if(c==='{'){const o=extractBalancedFromStringToJSON(s,i,'{','}');if(o)return o}if(c==='['){const a=extractBalancedFromStringToJSON(s,i,'[',']');if(a&&Array.isArray(a))return{filled_form:a}}}
      try{const d=JSON.parse(s);if(Array.isArray(d))return{filled_form:d};return d}catch(_){return null}
    }
    function filterFilled(arr){return arr.filter(it=>!isInstructionLike(it.question));}

    let MARCO_TXT='',EDITAL_TXT='',FORM_TXT='';
    $('#marcoFile').addEventListener('change',async()=>{MARCO_TXT=await handleFile($('#marcoFile'),$('#marcoInfo'),readAny);});
    $('#editalFile').addEventListener('change',async()=>{EDITAL_TXT=await handleFile($('#editalFile'),$('#editalInfo'),readAny);});
    $('#formFile').addEventListener('change',async()=>{FORM_TXT=await handleFile($('#formFile'),$('#formInfo'),readAny);});

    async function callBackend(questionsChunk,meta){
      const compact={
        lang:'pt-BR',
        questions_lang:'es',
        force_pt_br:true,
        project:meta.project,
        partner:meta.partner,
        notes:meta.notes,
        questions:questionsChunk,
        edital_criteria:[],
        marco_excerpt:safeSlice(MARCO_TXT,6000),
        edital_excerpt:safeSlice(EDITAL_TXT,8000),
        form_excerpt:safeSlice(FORM_TXT,4000)
      };
      const compact_b64=btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
      const payload={lang:compact.lang,project:compact.project,partner:compact.partner,outFile:meta.outFile,notes:compact.notes,compact_b64:compact_b64,q_count:questionsChunk.length};
      const {ok,status,statusText,headers,text}=await safeFetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},body:JSON.stringify(payload)});
      $('#debug').textContent=`Status: ${status} ${statusText}\ncontent-type: ${headers.get('content-type')||''}\nQs lote: ${questionsChunk.length}\n\nRAW:\n${(text||'').slice(0,1200)}`;
      show($('#debug'));
      if(!ok)throw new Error(`HTTP ${status} ${statusText}`);
      const resp=(text||'').trim(); if(resp.toLowerCase()==='accepted')throw new Error('Webhook sem corpo JSON');
      const data=extractFirstJSONValue(resp);
      if(!data||!Array.isArray(data.filled_form))throw new Error('Resposta inválida do backend ou sem filled_form.');
      return filterFilled(data.filled_form);
    }

    document.getElementById('formTool').addEventListener('submit',async e=>{
      e.preventDefault();hide($('#debug'));
      const st=$('#status');st.classList.remove('error','success');st.textContent='';
      if(!MARCO_TXT||!EDITAL_TXT||!FORM_TXT){st.textContent='Anexe os três arquivos.';st.classList.add('error');return;}
      try{
        $('#submitBtn').disabled=true;st.textContent='Extraindo perguntas...';
        let questions=parseFormQuestionsGeneric(FORM_TXT);
        if(questions.length===0)throw new Error('Nenhuma pergunta válida encontrada no formulário.');
        // Particiona em lotes estáveis
        const batches=[];for(let i=0;i<questions.length;i+=BATCH_SIZE){batches.push(questions.slice(i,i+BATCH_SIZE));}

        st.textContent=`Enviando ${batches.length} lote(s)...`;
        const meta={project:($('#projectName').value||'').trim(),partner:($('#partnerName').value||'').trim(),notes:($('#notes').value||'').trim(),outFile:($('#outFile').value||'').trim()};
        let filledAll=[];
        for(let b=0;b<batches.length;b++){
          st.textContent=`Processando lote ${b+1}/${batches.length}...`;
          const part=await callBackend(batches[b],meta);
          filledAll=filledAll.concat(part);
        }
        if(filledAll.length===0)throw new Error('Sem respostas após processamento.');

        const doc=docFromFilled(filledAll,{title:'Proposta — Formulário Preenchido',project:meta.project,partner:meta.partner});
        const fname=meta.outFile||(meta.project?meta.project.replace(/[^a-zA-Z0-9_\- ]/g,'').replace(/\s+/g,'_')+'_pt-BR.docx':'Proposta_pt-BR.docx');
        await saveDocx(doc,fname);
        st.textContent='✓ DOCX gerado com sucesso';st.classList.add('success');
      }catch(err){st.textContent='Erro: '+err.message;st.classList.add('error');}
      finally{$('#submitBtn').disabled=false;}
    });
  </script>
</body>
</html>

